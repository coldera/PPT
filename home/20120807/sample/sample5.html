<!DOCTYPE HTML>
<html>
<head>
<title>Canvas Demo 3</title>
<meta charset="utf-8" />

<style>
html {text-align: center;}
canvas, img {border:1px solid #ccc; vertical-align: top;}
</style>
</head>
<body onselectstart="return false">
<img src="1.jpg" />
<canvas id="demo" width=312 height=441></canvas>
<input type="button" onclick="adjust(0,0,-100)" value="通道调整"/>
<input type="button" onclick="brighten(-30)" value="亮度"/>
<input type="button" onclick="saturate(80)" value="饱和度"/>
<input type="button" onclick="contrast(80)" value="对比度"/>
<input type="button" onclick="invert()" value="反相"/>
<input type="button" onclick="sepia()" value="旧照片"/>
<input type="button" onclick="gaussian()" value="高斯模糊"/>
<input type="button" onclick="sharpen()" value="锐化"/>
<script type="text/javascript">
var demo = document.querySelector('#demo').getContext('2d');
var test_image;

function drawImage() {
    demo.clearRect(0,0,312,441);
    
    if(test_image) {
        demo.drawImage(test_image, 0, 0);
    }else {
        test_image = new Image();
        test_image.src = '1.jpg';
        
        test_image.onload = function() {
            demo.drawImage(test_image, 0, 0);
        }
    }
}

drawImage();

function convolve(kernel, buffer, w, h) {    

    var temp  = demo.createImageData(buffer.width, buffer.height),
        tempd = temp.data,
        bufferData = buffer.data,
        kh = parseInt(kernel.length / 2),
        kw = parseInt(kernel[0].length / 2),
        i = 0, j = 0, n = 0, m = 0;
    
    for (i = 0; i < h; i++) {
        for (j = 0; j < w; j++) {
            var outIndex = (i*w*4) + (j*4);
            var r = 0, g = 0, b = 0;
            for (n = -kh; n <= kh; n++) {
                for (m = -kw; m <= kw; m++) {
                    if (i + n >= 0 && i + n < h) {
                        if (j + m >= 0 && j + m < w) {
                            var f = kernel[n + kh][m + kw];
                            if (f === 0) {continue;}
                            var inIndex = ((i+n)*w*4) + ((j+m)*4);
                            r += bufferData[inIndex] * f;
                            g += bufferData[inIndex + 1] * f;
                            b += bufferData[inIndex + 2] * f;
                        }
                    }
                }
            }
            tempd[outIndex]     = clamp(r);
            tempd[outIndex + 1] = clamp(g);
            tempd[outIndex + 2] = clamp(b);
            tempd[outIndex + 3] = 255;
        }
    }
    return temp;
}

function clamp(val, min, max) {
    min = min || 0;
    max = max || 255;
    return Math.min(max, Math.max(min, val));
}

function dist(x1, x2) {
    return Math.sqrt(Math.pow(x2 - x1, 2));
}

function normalize(val, dmin, dmax, smin, smax) {
    var sdist = dist(smin, smax),
        ddist = dist(dmin, dmax),
        ratio = ddist / sdist,
        val   = clamp(val, smin, smax);
    return dmin + (val-smin) * ratio;
}

function changePixelData(data, fn) {
    var i = 0, j = 0, w=312, h=441;
    for (i = 0; i < h; i++) {
        for (j = 0; j < w; j++) {
            
            var index = (i*w*4) + (j*4);
            
            var rgba  = {
                r: data[index],
                g: data[index + 1],
                b: data[index + 2],
                a: data[index + 3]
            };
            
            fn(rgba, j, i);

            data[index] = parseInt(clamp(rgba.r));
            data[index + 1] = parseInt(clamp(rgba.g));
            data[index + 2] = parseInt(clamp(rgba.b));  
            data[index + 3] = parseInt(clamp(rgba.a));  
        }
    }
}

function adjust(r,g,b) {
    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);
    changePixelData(buffer.data, function(rgba) {
        rgba.r += r;
        rgba.g += g;
        rgba.b += b;
    });
    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

// [-100, 100]
function brighten(p) {
    p = normalize(p, -255, 255, -100, 100);

    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);
    changePixelData(buffer.data, function(rgba) {
        rgba.r += p;
        rgba.g += p;
        rgba.b += p;
    });
    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

// #### Saturate [-100, 100]
function saturate(p) {
    p = normalize(p, 0, 2, -100, 100);

    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);
    changePixelData(buffer.data, function(rgba) {
        var avg = (rgba.r + rgba.g + rgba.b) / 3;
        rgba.r = avg + p * (rgba.r - avg);
        rgba.g = avg + p * (rgba.g - avg);
        rgba.b = avg + p * (rgba.b - avg);
    });
    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

function invert() {
    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);
    changePixelData(buffer.data, function(rgba) {
        rgba.r = 255 - rgba.r;
        rgba.g = 255 - rgba.g;
        rgba.b = 255 - rgba.b;
    });
    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

function contrast(p) {
    p = normalize(p, 0, 2, -100, 100);
    
    function c(f, c){
        return (f - 0.5) * c + 0.5;
    }

    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);
    changePixelData(buffer.data, function(rgba) {
        rgba.r = 255 * c(rgba.r / 255, p);
        rgba.g = 255 * c(rgba.g / 255, p);
        rgba.b = 255 * c(rgba.b / 255, p);
    });
    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

function sepia() {
    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);
    changePixelData(buffer.data, function(rgba) {
        var r = rgba.r, g = rgba.g, b = rgba.b;
        rgba.r = (r * 0.393) + (g * 0.769) + (b * 0.189);
        rgba.g = (r * 0.349) + (g * 0.686) + (b * 0.168);
        rgba.b = (r * 0.272) + (g * 0.534) + (b * 0.131);
    });
    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

function gaussian() {
    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);

    buffer = convolve([
        [1/273, 4/273, 7/273, 4/273, 1/273],
        [4/273, 16/273, 26/273, 16/273, 4/273],
        [7/273, 26/273, 41/273, 26/273, 7/273],
        [4/273, 16/273, 26/273, 16/273, 4/273],             
        [1/273, 4/273, 7/273, 4/273, 1/273]
    ], buffer,312,441);

    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

function sharpen() {
    demo.save();
    
    drawImage();
    var buffer = demo.getImageData(0,0,312,441);

    buffer = convolve([
        [0.0, -0.2,  0.0],
        [-0.2, 1.8, -0.2],
        [0.0, -0.2,  0.0]
    ], buffer,312,441);

    demo.putImageData(buffer, 0, 0);
    
    demo.restore();
}

</script>
</body>
</html>